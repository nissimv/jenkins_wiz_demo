name: Scheduled or Manual Wiz CLI Scan

on:
  workflow_dispatch:       # Allows a user-initiated scan from the GitHub UI
  schedule:
    - cron: '0 4 * * *'    # Runs every day at 04:00 UTC (customize as needed)

jobs:
  wiz-cli-iac-scan:
    name: Wiz CLI IaC Scan
    runs-on: ubuntu-latest
    env:
      SCAN_PATH: "."           # Root of the repository, adjust as needed
      POLICY: "Default IaC policy" # Policy name defined in Wiz Portal (must match the blocking secret rule)
    defaults:
      run:
        shell: bash

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Download Wiz CLI
        run: |
          curl -o wizcli https://downloads.wiz.io/wizcli/latest/wizcli-linux-amd64
          chmod +x wizcli

      - name: Authenticate to Wiz
        run: ./wizcli auth --id "$WIZ_CLIENT_ID" --secret "$WIZ_CLIENT_SECRET"
        env:
          WIZ_CLIENT_ID: ${{ secrets.WIZ_CLIENT_ID }}
          WIZ_CLIENT_SECRET: ${{ secrets.WIZ_CLIENT_SECRET }}

      - name: Run Wiz CLI scan
        run: ./wizcli iac scan --path $SCAN_PATH --policy "$POLICY"

